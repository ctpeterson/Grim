#!/bin/bash
# ==========================================================================
# Grim lattice field theory framework
# Source file: configure
#
# Run this *after* bootstrap.py has installed Grid and its dependencies.
# Finds the Nim compiler and Grid installation (via grid-config), then
# generates build/Makefile, build/Makefile.nims, and build/nim.cfg.
#
# All MPI, OpenMP, SIMD, and accelerator flags are already baked into
# grid-config by bootstrap — configure simply passes them through.
#
# Usage:
#   ./configure [OPTIONS]
#
# Options:
#   --grid-prefix=PATH   Path to Grid install prefix
#                         (default: ./local/grid-install)
#   --nim=PATH           Path to nim compiler
#                         (default: <grid-prefix>/bin/nim)
#   --cc=COMPILER        C++ compiler override (default: clang, falls back to gcc)
#   --jobs=N             Default parallel build jobs (default: nproc)
# ==========================================================================

set -e

# ── Resolve paths ─────────────────────────────────────────────────────────
CWD="$(pwd)"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SRC_DIR="${SCRIPT_DIR}/src"

# ── Defaults ──────────────────────────────────────────────────────────────
# bootstrap.py installs Grid into <cwd>/grid-install when run from local/
GRID_PREFIX="${SCRIPT_DIR}/local/grid-install"
NIM=""
CC=""
JOBS=$(nproc 2>/dev/null || echo 4)

# ── Parse arguments ──────────────────────────────────────────────────────
for arg in "$@"; do
    case "$arg" in
        --grid-prefix=*)  GRID_PREFIX="${arg#*=}" ;;
        --nim=*)          NIM="${arg#*=}" ;;
        --cc=*)           CC="${arg#*=}" ;;
        --jobs=*)         JOBS="${arg#*=}" ;;
        --help|-h)
            sed -n '2,/^# =====/p' "${BASH_SOURCE[0]}" | grep '^#' | sed 's/^# \?//'
            exit 0
            ;;
        *)
            echo "Unknown option: $arg"
            echo "Run '$0 --help' for usage."
            exit 1
            ;;
    esac
done

# ── Resolve compiler ─────────────────────────────────────────────────────
# bootstrap writes deps/compiler.env with the resolved CC/CXX and any
# PATH additions (e.g. for a locally-installed LLVM).
_CC_FROM_ARG="$CC"  # preserve any explicit --cc argument
_COMPILER_ENV="${SCRIPT_DIR}/local/deps/compiler.env"
if [ -f "$_COMPILER_ENV" ]; then
    echo "-- Sourcing compiler config: $_COMPILER_ENV"
    . "$_COMPILER_ENV"
fi
# --cc= argument takes precedence over compiler.env
[ -n "$_CC_FROM_ARG" ] && CC="$_CC_FROM_ARG"

# Auto-detect if still unset, preferring clang
if [ -z "$CC" ]; then
    for _try_cc in clang gcc cc; do
        if command -v "$_try_cc" >/dev/null 2>&1; then
            CC="$_try_cc"
            break
        fi
    done
    : "${CC:=gcc}"  # ultimate fallback
fi

# ── Find Nim ──────────────────────────────────────────────────────────────
# bootstrap installs Nim into the same prefix as Grid
if [ -z "$NIM" ]; then
    if [ -x "${GRID_PREFIX}/bin/nim" ]; then
        NIM="${GRID_PREFIX}/bin/nim"
    elif command -v nim >/dev/null 2>&1; then
        NIM=$(command -v nim)
    else
        echo "ERROR: nim not found at ${GRID_PREFIX}/bin/nim or in PATH."
        echo "       Run bootstrap.py first, or pass --nim=/path/to/nim"
        exit 1
    fi
fi
echo "-- Nim:  $NIM ($("$NIM" --version 2>&1 | head -1))"

# ── Find grid-config ────────────────────────────────────────────────────
GRID_CONFIG="${GRID_PREFIX}/bin/grid-config"
if [ ! -x "$GRID_CONFIG" ]; then
    echo "ERROR: grid-config not found at $GRID_CONFIG"
    echo "       Run bootstrap.py first, or pass --grid-prefix=<path>"
    exit 1
fi

GRID_CXXFLAGS=$("$GRID_CONFIG" --cxxflags)
GRID_LDFLAGS=$("$GRID_CONFIG" --ldflags)
GRID_LIBS=$("$GRID_CONFIG" --libs)

echo "-- Grid: $GRID_PREFIX"
echo "   cxxflags: $GRID_CXXFLAGS"
echo "   ldflags:  $GRID_LDFLAGS"
echo "   libs:     $GRID_LIBS"

# ── Find C++ compiler & derive Nim compiler name ────────────────────────
# Nim's --cc: flag expects a compiler *family* (gcc, clang, …), not a path.
case "$CC" in
    *clang*) NIM_CC="clang" ;;
    *)       NIM_CC="gcc" ;;
esac

CXX_PATH=$(command -v "$CC" 2>/dev/null || true)
if [ -z "$CXX_PATH" ]; then
    for try_cc in clang gcc g++ c++; do
        CXX_PATH=$(command -v "$try_cc" 2>/dev/null || true)
        if [ -n "$CXX_PATH" ]; then
            CC="$try_cc"
            case "$CC" in
                *clang*) NIM_CC="clang" ;;
                *)       NIM_CC="gcc" ;;
            esac
            break
        fi
    done
fi
echo "-- C++:  $CC${CXX_PATH:+ ($CXX_PATH)} (Nim --cc:$NIM_CC)"

# ── Create directories ──────────────────────────────────────────────────
mkdir -p "${CWD}/build" "${CWD}/bin" "${CWD}/cache"

# ── Symlink src/ from project root if not present ────────────────────────
if [ ! -e "${CWD}/src" ] && [ -d "${SCRIPT_DIR}/src" ]; then
    ln -snf "${SCRIPT_DIR}/src" "${CWD}/src"
    echo "-- Symlinked src -> ${SCRIPT_DIR}/src"
fi

# ── Generate nim.cfg ─────────────────────────────────────────────────────
NIM_CFG="${CWD}/build/nim.cfg"
cat > "$NIM_CFG" <<EOF
# Auto-generated by Grim configure on $(date)
# Do not edit — re-run configure to regenerate.
# All flags come from grid-config (set during bootstrap).
EOF

for flag in $GRID_CXXFLAGS; do
    echo "  passC = \"$flag\"" >> "$NIM_CFG"
done
for flag in $GRID_LDFLAGS; do
    echo "  passL = \"$flag\"" >> "$NIM_CFG"
done
for flag in $GRID_LIBS; do
    echo "  passL = \"$flag\"" >> "$NIM_CFG"
done

echo "-- Generated $NIM_CFG"

# ── Generate Makefile.nims ───────────────────────────────────────────────
NIMS="${CWD}/build/Makefile.nims"
cat > "$NIMS" <<'NIMS_HEADER'
#[ Grim lattice field theory framework
   Source file: build/Makefile.nims
   Auto-generated by configure — re-run configure to regenerate.
]#

import std/[os, strutils]

proc `/`*(sa, sb: string): string = sa & "/" & sb
proc `+`*(sa, sb: string): string = sa & " " & sb
proc `+=`*(sa: var string, sb: string) = sa = sa & " " & sb

NIMS_HEADER

cat >> "$NIMS" <<NIMS_CONFIG
### configuration — written by configure ###

const cwd      = getCurrentDir()
const nimCache = cwd / "cache"
const srcDir   = cwd / "src"
const nim      = "${NIM}"
const compiler = "${NIM_CC}"
const gridCfg  = "${GRID_CONFIG}"

# Grid flags — everything (MPI, OpenMP, SIMD, accelerator) is in here
const passC_Grid = staticExec(gridCfg + " --cxxflags")
const passL_Grid = staticExec(gridCfg + " --ldflags") & " " &
                   staticExec(gridCfg + " --libs")

NIMS_CONFIG

cat >> "$NIMS" <<'NIMS_BODY'
### build logic ###

proc search(dir, src: string): string {.raises: [IOError].} =
  ## Recursively search `dir` for `src.nim` and return its path.
  for entry in walkDirRec(dir):
    if entry.splitPath().tail == src & ".nim":
      return string(entry)
  raise newException(IOError, src & ".nim not found under " & dir)

task clean, "remove compiled binaries and cache":
  exec "rm -rf" + cwd / "bin/*"
  exec "rm -rf" + nimCache

task list, "list available build targets in src/":
  echo "Available targets in " & srcDir & ":"
  for entry in walkDirRec(srcDir):
    if entry.endsWith(".nim"):
      echo "  " & entry.relativePath(srcDir).changeFileExt("")

task build, "compile a Nim source from src/":
  var passC = "-Ofast" + passC_Grid
  var passL = "-Wl,--start-group" + passL_Grid + "-Wl,--end-group"

  # Arguments after "build": extra flags followed by target name (last arg)
  var args = newSeq[string](paramCount() - 2)
  for i in 0 ..< args.len:
    args[i] = paramStr(i + 3)

  if args.len == 0:
    echo "Usage: nim build build/Makefile.nims <target> [extra-flags...]"
    echo "Run  'nim list build/Makefile.nims' to see available targets."
    return

  let target = args[^1]
  let nimSrc = search(srcDir, target)

  var cmpl = nim + "cpp"
  cmpl += "--path:" & srcDir
  # Add all subdirectories as search paths so bare imports resolve
  for d in walkDirRec(srcDir, yieldFilter = {pcDir}):
    cmpl += "--path:" & d
  cmpl += "--nimcache:" & nimCache
  cmpl += "--cc:" & compiler
  cmpl += "--passC:\"" & passC & "\""
  cmpl += "--passL:\"" & passL & "\""

  # Extra user flags (everything before the target name)
  for i in 0 ..< (args.len - 1):
    cmpl += args[i]

  cmpl += "-o:" & cwd / "bin" / target
  cmpl += nimSrc

  echo "BUILD: " & cmpl
  exec cmpl
NIMS_BODY

echo "-- Generated $NIMS"

# ── Generate Makefile ────────────────────────────────────────────────────
MK="${CWD}/build/Makefile"
cat > "$MK" <<MAKEFILE
# Grim lattice field theory framework
# Auto-generated by configure on $(date)
# Do not edit — re-run configure to regenerate.

NIM = ${NIM}

# ── Compile-time flags ───────────────────────────────────────────────────
# Usage: make <target> RELEASE=1

FLAGS =

ifdef RELEASE
FLAGS += -d:danger
endif

ifdef DEBUG
FLAGS += --debugger:native --lineDir:on
endif

ifdef PROFILE
FLAGS += -d:ProfileMode:1
endif

# ── Phony targets ────────────────────────────────────────────────────────

.PHONY: help clean list

help:
	@echo ""
	@echo "Grim Build System"
	@echo "=================="
	@echo ""
	@echo "Usage: make <target> [OPTIONS]"
	@echo ""
	@echo "Targets:"
	@echo "  <name>       Build src/<name>.nim (e.g. make grim)"
	@echo "  list         List available targets in src/"
	@echo "  clean        Remove compiled binaries and cache"
	@echo "  help         Show this help message"
	@echo ""
	@echo "Options:"
	@echo "  RELEASE=1    Disable runtime checks, max optimisation"
	@echo "  DEBUG=1      Enable native debugger + line info"
	@echo "  PROFILE=1    Enable timing instrumentation"
	@echo "  ARGS=\"...\"   Pass arbitrary extra Nim flags"
	@echo ""

list:
	\$(NIM) list build/Makefile.nims

clean:
	\$(NIM) clean build/Makefile.nims

# ── Catch-all: treat unknown targets as Nim source names ─────────────────

BUILD_TARGETS := \$(filter-out help clean list,\$(MAKECMDGOALS))

ifneq (\$(BUILD_TARGETS),)
\$(BUILD_TARGETS): build-impl
	@true

.PHONY: build-impl
build-impl:
	\$(NIM) build build/Makefile.nims \$(FLAGS) \$(ARGS) \$(BUILD_TARGETS)
endif
MAKEFILE

echo "-- Generated $MK"

# ── Top-level Makefile symlink ───────────────────────────────────────────
ln -snf "${CWD}/build/Makefile" "${CWD}/Makefile"
echo "-- Symlinked Makefile -> build/Makefile"

# ── Done ─────────────────────────────────────────────────────────────────
echo ""
echo "  Grim configured successfully."
echo "  Grid prefix: ${GRID_PREFIX}"
echo ""
echo "  make list              # see available targets"
echo "  make <target>          # compile src/<target>.nim"
echo "  make <target> RELEASE=1  # optimised build"
echo ""
